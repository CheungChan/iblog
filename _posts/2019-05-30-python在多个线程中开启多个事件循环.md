---
title: pythonåœ¨å¤šä¸ªçº¿ç¨‹å½“ä¸­,å¼€å¯å¤šä¸ªäº‹ä»¶å¾ªç¯
key: python_multi_loop_in_multi_thread
layout: article
date: '2019-05-30 16:25:00'
tags: æ€»ç»“ python 
typora-root-url: ../../iblog


---

## å‚è€ƒé“¾æ¥

[æ·±å…¥ç†è§£asyncio(ä¸‰)](https://mp.weixin.qq.com/s/ZniLWGVj7C7JxPs0hhm4QQ)

[æˆ‘è‡ªå·±å†™çš„æ€»ç»“](https://blog.azhangbaobao.cn/2019/05/29/%E6%80%BB%E7%BB%93asynicio.html)

### èƒŒæ™¯

æˆ‘ä¸€ç›´åœ¨æƒ³, è™½ç„¶å¼‚æ­¥ä»£ç åˆ‡æ¢å¾ˆå¿«, æ¯”å¤šçº¿ç¨‹å¤šè¿›ç¨‹èƒ½åˆ›å»ºæ›´å¤šçš„åç¨‹æ¥æ”¯æŒå¹¶å‘. ä½†æ˜¯äº‹ä»¶å¾ªç¯åªèƒ½åœ¨å•è¿›ç¨‹å•çº¿ç¨‹å½“ä¸­è¿›è¡Œå¹¶å‘.

æœ‰æ²¡æœ‰å¯èƒ½åœ¨å¤šçº¿ç¨‹ä¸­, æ¯ä¸ªçº¿ç¨‹å†å¼€å¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯å‘¢? ç ”è¯»äº†è‘£ä¼Ÿæ˜çš„å…¬ä¼—å·ä¹‹å, å‘ç°åŸæ¥å¯ä»¥ğŸ˜º. ä½†æ˜¯å¤šè¿›ç¨‹ä¸å¯ä»¥. å› ä¸ºEventLoopå¯¹è±¡ä¸èƒ½è¢«ç®¡é“ä¼ é€’, è€Œpythonå¤šè¿›ç¨‹çš„æœ¬è´¨æ˜¯åº•å±‚é€šè¿‡ç®¡é“æ¥å‘é€æ¶ˆæ¯è¿›è¡Œé€šä¿¡.

### é€»è¾‘è¦ç‚¹

åœ¨ä¸»çº¿ç¨‹å½“ä¸­é€šè¿‡`asyncio.new_event_loop`åˆ›å»ºä¸‰ä¸ªäº‹ä»¶å¾ªç¯. ç„¶åå¼€å¯ä¸‰ä¸ªçº¿ç¨‹, åˆ†åˆ«å°†å¯¹åº”çš„äº‹ä»¶å¾ªç¯è·‘èµ·æ¥. é€šè¿‡`asyncio.run_coroutine_threadsafe(coroutine_object, loop_object)`æ¥è®©åç¨‹åœ¨å…¶ä»–çº¿ç¨‹ä¸­è¿è¡Œ. è¿è¡Œå®Œä¹‹åä¸€å®šè¦å…³é—­äº‹ä»¶å¾ªç¯, å¦åˆ™`loop.run_forever()`ä¼šé˜»å¡çº¿ç¨‹å…³é—­, å¯ä»¥é€šè¿‡`loop.call_soon_threadsafe(callback)`åœ¨callbackå‡½æ•°ä¸­å…³é—­äº‹ä»¶å¾ªç¯.

### Code

```python
# -*- coding: utf-8 -*-
__author__ = 'é™ˆç« '
__date__ = '2019-05-30 16:46'

import asyncio
import time
from functools import partial
from threading import Thread, current_thread


async def a():
    # è¦æ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°
    await asyncio.sleep(1)
    return f"return value from {current_thread().name}"


def start_loop(loop):
    # åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹çš„targetå‡½æ•°ä¸­å¯åŠ¨äº‹ä»¶å¾ªç¯
    asyncio.set_event_loop(loop)
    loop.run_forever()


def stop_loop(loop):
    # åœ¨ä»»åŠ¡å®Œæˆä¹‹åé€šè¿‡call_soon_threadsafeå…³é—­äº‹ä»¶å¾ªç¯
    loop.stop()


async def main():
    start = time.perf_counter()
    # åˆ›å»ºä¸‰ä¸ªäº‹ä»¶å¾ªç¯, è®©æ¯ä¸€ä¸ªçº¿ç¨‹å»å¼€å¯
    new_loop1 = asyncio.new_event_loop()
    new_loop2 = asyncio.new_event_loop()
    new_loop3 = asyncio.new_event_loop()
    t1 = Thread(target=start_loop, args=(new_loop1,))
    t2 = Thread(target=start_loop, args=(new_loop2,))
    t3 = Thread(target=start_loop, args=(new_loop3,))
    t1.start()
    t2.start()
    t3.start()
    # ä½¿ç”¨asyncio.run_coroutine_threadsafeè®©ä»»åŠ¡åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œ, çº¿ç¨‹å®‰å…¨.
    # åœ¨è¿™é‡Œæ¯ä¸ªçº¿ç¨‹æˆ‘å¼€å¯äº†3ä¸ªä»»åŠ¡
    future1, future2, future3 = [asyncio.run_coroutine_threadsafe(a(), new_loop1) for i in range(3)]
    future4, future5, future6 = [asyncio.run_coroutine_threadsafe(a(), new_loop2) for i in range(3)]
    future7, future8, future9 = [asyncio.run_coroutine_threadsafe(a(), new_loop3) for i in range(3)]
    all_futures = [future1, future2, future3, future4, future5, future6, future7, future8, future9]
    print(all_futures)
    # è·å–ç»“æœ, timeoutè¦å¤§äºä»»åŠ¡æ‰§è¡Œæ—¶é—´,å¦åˆ™ä¼šæŠ¥é”™TimeoutError
    print([f.result(timeout=2) for f in all_futures])
    # é€šè¿‡loop.call_soon_threadsafeåœ¨ä»»åŠ¡ç»“æŸä¹‹åå…³é—­äº‹ä»¶å¾ªç¯
    new_loop1.call_soon_threadsafe(partial(stop_loop, new_loop1))
    new_loop2.call_soon_threadsafe(partial(stop_loop, new_loop2))
    new_loop3.call_soon_threadsafe(partial(stop_loop, new_loop3))
    end = time.perf_counter()
    print(end - start)


if __name__ == "__main__":
    asyncio.run(main())
    
    
"""
Output:
[<Future at 0x10ac58160 state=pending>, <Future at 0x10ac581d0 state=pending>, <Future at 0x10ac58240 state=pending>, <Future at 0x10ac582b0 state=pending>, <Future at 0x10ac58320 state=pending>, <Future at 0x10ac58390 state=pending>, <Future at 0x10ac58400 state=pending>, <Future at 0x10ac58470 state=pending>, <Future at 0x10ac584e0 state=pending>]
['return value from Thread-1', 'return value from Thread-1', 'return value from Thread-1', 'return value from Thread-2', 'return value from Thread-2', 'return value from Thread-2', 'return value from Thread-3', 'return value from Thread-3', 'return value from Thread-3']
1.006172254
"""
```

